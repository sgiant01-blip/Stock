# -*- coding: utf-8 -*-
"""
KRX ì¢…ëª©ë³„ OHLCV + íˆ¬ììë³„ change(openâ€“close) ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸
- change = ì‹œê°€(open) - ì¢…ê°€(close)
- ê²°ì¸¡ changeëŠ” 0ìœ¼ë¡œ ì±„ì›€
- ì§„í–‰ ìƒí™©ì€ tqdm í”„ë¡œê·¸ë ˆìŠ¤ë°”ë¡œ í‘œì‹œ
- ê²°ê³¼ë¥¼ CSVì™€ Parquetìœ¼ë¡œ ì €ì¥
- ìˆ˜ì§‘ ì‹¤íŒ¨ ì¢…ëª©ì€ error.logì— ì½”ë“œì™€ ì‚¬ìœ  ê¸°ë¡
"""

import time
import pandas as pd
from pykrx import stock
from tqdm import tqdm

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
data_Name  = "data.KRX"
OUT_CSV    = data_Name + ".csv"
OUT_PARQ   = data_Name + ".parquet"
ERROR_LOG  = data_Name + ".error.log"

# ì¡°íšŒ ê¸°ê°„ (YYYYMMDD)
start_date = "20150102"
end_date   = "20250927"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ì¢…ëª© ì½”ë“œ ë° ë©”íƒ€ ì •ë³´ ì¡°íšŒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
kospi_codes  = stock.get_market_ticker_list(end_date, market="KOSPI")
kosdaq_codes = stock.get_market_ticker_list(end_date, market="KOSDAQ")
codes        = kospi_codes + kosdaq_codes

def get_meta(code: str):
    """ì¢…ëª© ì½”ë“œ â†’ (Name, Market) ë°˜í™˜"""
    name   = stock.get_market_ticker_name(code)
    market = "KOSPI" if code in kospi_codes else "KOSDAQ"
    return name, market

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ìˆ˜ì§‘ ë£¨í”„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
result_list = []
errors      = []

print("ğŸ“Š ì¢…ëª©ë³„ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘:")

for code in tqdm(codes,
                 desc="ìˆ˜ì§‘ ì§„í–‰",
                 total=len(codes),
                 unit="ì¢…ëª©",
                 ncols=80):
    try:
        name, market = get_meta(code)

        # 3-1) OHLCV ë°ì´í„°
        df = stock.get_market_ohlcv(start_date, end_date, code)
        df.reset_index(inplace=True)  # 'ë‚ ì§œ' ì»¬ëŸ¼ì„ ì¼ë°˜ ì»¬ëŸ¼ìœ¼ë¡œ

        # 3-2) ì»¬ëŸ¼ëª… í†µì¼
        df.rename(columns={
            "ë‚ ì§œ":   "date",
            "ì‹œê°€":    "open",
            "ê³ ê°€":    "high",
            "ì €ê°€":    "low",
            "ì¢…ê°€":    "close",
            "ê±°ë˜ëŸ‰":   "volume"
        }, inplace=True)

        # 3-3) change ê³„ì‚°: open â€“ close, ê²°ì¸¡ê°’ 0
        df["change"] = (df["open"] - df["close"]).fillna(0)

        # 3-4) ë©”íƒ€ ì»¬ëŸ¼ ì¶”ê°€
        df["Code"]   = code
        df["Company"]   = name
        df["Market"] = market

        result_list.append(df)

        # Optional: ì„œë²„ ë¶€ë‹´ ì™„í™”
        time.sleep(0.05)

    except Exception as e:
        # ì‹¤íŒ¨ ì¢…ëª© ê¸°ë¡
        errors.append((code, str(e)))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ê²°ê³¼ í•©ì¹˜ê¸° ë° ì €ì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nâœ… ìˆ˜ì§‘ ì™„ë£Œ. ë°ì´í„° ë³‘í•© ë° ì €ì¥ ì¤‘â€¦")

if not result_list:
    raise RuntimeError("ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤.")

# 4-1) í•˜ë‚˜ì˜ DataFrameìœ¼ë¡œ ë³‘í•©
final_df = pd.concat(result_list, ignore_index=True)

# 4-2) ì»¬ëŸ¼ ìˆœì„œ ì¬ì •ë ¬
cols = ["Code", "Company", "Market", "date",
        "open", "high", "low", "close",
        "volume", "change"]
final_df = final_df[cols]

# 4-3) CSV ì €ì¥
final_df.to_csv(OUT_CSV, index=False, encoding="utf-8-sig")
print(f"ğŸ“ CSV ì €ì¥ ì™„ë£Œ: {OUT_CSV}")

# 4-4) Parquet ì €ì¥ (pyarrow ë˜ëŠ” fastparquet í•„ìš”)
final_df.to_parquet(OUT_PARQ, index=False)
print(f"ğŸ“ Parquet ì €ì¥ ì™„ë£Œ: {OUT_PARQ}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if errors:
    with open(ERROR_LOG, "w", encoding="utf-8") as f:
        for code, reason in errors:
            f.write(f"{code}\t{reason}\n")
    print(f"âŒ ì—ëŸ¬ ë¡œê·¸ ì €ì¥: {ERROR_LOG} ({len(errors)}ê±´)")
else:
    print("âœ… ëª¨ë“  ì¢…ëª© ì •ìƒ ìˆ˜ì§‘ë¨. ì—ëŸ¬ ì—†ìŒ.")

